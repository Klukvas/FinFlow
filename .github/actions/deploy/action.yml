name: Deploy via SSH and Compose
description: SSH to host, write compose and env, pull images, and recreate services

inputs:
  host:
    description: Target host
    required: true
  user:
    description: SSH user
    required: true
    default: root
  ssh-private-key:
    description: SSH private key
    required: true
  registry:
    description: Registry for images
    required: true
  image-prefix:
    description: Image namespace/prefix
    required: true
  db-host:
    description: Database host
    required: true
  db-port:
    description: Database port
    required: true
    default: "5432"
  db-name:
    description: Database name
    required: true
  db-user:
    description: Database user
    required: true
  db-password:
    description: Database password
    required: true
  services:
    description: Space-separated services to deploy
    required: true
    default: "frontend account_service category_service currency_service debt_service expense_service goals_service income_service pdf_parser_service recurring_service user_service"

runs:
  using: "composite"
  steps:
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ inputs['ssh-private-key'] }}

    - name: Add host key
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p ~/.ssh
        ssh-keyscan -H "${{ inputs.host }}" >> ~/.ssh/known_hosts

    - name: Deploy over SSH
      shell: bash
      env:
        HOST: ${{ inputs.host }}
        USER: ${{ inputs.user }}
        REGISTRY: ${{ inputs.registry }}
        IMAGE_PREFIX: ${{ inputs['image-prefix'] }}
        DB_HOST: ${{ inputs['db-host'] }}
        DB_PORT: ${{ inputs['db-port'] }}
        DB_NAME: ${{ inputs['db-name'] }}
        DB_USER: ${{ inputs['db-user'] }}
        DB_PASSWORD: ${{ inputs['db-password'] }}
        SERVICES: ${{ inputs.services }}
      run: |
        set -euo pipefail
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš€ Starting deployment process"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Host: $HOST"
        echo "User: $USER"
        echo "Registry: $REGISTRY"
        echo "Services: ${SERVICES:-<empty>}"

        # Use default services if empty
        if [ -z "${SERVICES:-}" ]; then
          SERVICES="frontend account_service category_service currency_service debt_service expense_service goals_service income_service pdf_parser_service recurring_service user_service"
          echo "Using default services: $SERVICES"
        fi

        echo ""
        echo "ğŸ“¦ Services to deploy: $SERVICES"
        echo ""

        ssh -o StrictHostKeyChecking=no "$USER@$HOST" bash -s <<-EOS
	set -euo pipefail
	mkdir -p ~/app
	cd ~/app

	cat > .env <<-ENVEOF
	REGISTRY=${REGISTRY}
	IMAGE_PREFIX=${IMAGE_PREFIX}
	DB_HOST=${DB_HOST}
	DB_PORT=${DB_PORT}
	DB_NAME=${DB_NAME}
	DB_USER=${DB_USER}
	DB_PASSWORD=${DB_PASSWORD}
	NODE_ENV=production
	ENVEOF

	cat > docker-compose.yml <<-COMPOSEEOF
	services:
	  frontend:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/frontend:latest
	    ports:
	      - "80:80"
	    environment:
	      - NODE_ENV=production
	    restart: unless-stopped

	  account_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/account_service:latest
	    environment:
	      - DATABASE_URL=postgresql://${DB_USER:-appuser}:${DB_PASSWORD:-password}@${DB_HOST:-localhost}:${DB_PORT:-5432}/${DB_NAME:-appdb}
	      - REDIS_URL=redis://redis:6379/0
	    depends_on:
	      - redis
	    restart: unless-stopped

	  category_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/category_service:latest
	    environment:
	      - DATABASE_URL=postgresql://${DB_USER:-appuser}:${DB_PASSWORD:-password}@${DB_HOST:-localhost}:${DB_PORT:-5432}/${DB_NAME:-appdb}
	    restart: unless-stopped

	  currency_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/currency_service:latest
	    restart: unless-stopped

	  debt_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/debt_service:latest
	    environment:
	      - DATABASE_URL=postgresql://${DB_USER:-appuser}:${DB_PASSWORD:-password}@${DB_HOST:-localhost}:${DB_PORT:-5432}/${DB_NAME:-appdb}
	    restart: unless-stopped

	  expense_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/expense_service:latest
	    environment:
	      - DATABASE_URL=postgresql://${DB_USER:-appuser}:${DB_PASSWORD:-password}@${DB_HOST:-localhost}:${DB_PORT:-5432}/${DB_NAME:-appdb}
	      - REDIS_URL=redis://redis:6379/0
	    depends_on:
	      - redis
	    restart: unless-stopped

	  goals_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/goals_service:latest
	    environment:
	      - DATABASE_URL=postgresql://${DB_USER:-appuser}:${DB_PASSWORD:-password}@${DB_HOST:-localhost}:${DB_PORT:-5432}/${DB_NAME:-appdb}
	    restart: unless-stopped

	  income_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/income_service:latest
	    environment:
	      - DATABASE_URL=postgresql://${DB_USER:-appuser}:${DB_PASSWORD:-password}@${DB_HOST:-localhost}:${DB_PORT:-5432}/${DB_NAME:-appdb}
	      - REDIS_URL=redis://redis:6379/0
	    depends_on:
	      - redis
	    restart: unless-stopped

	  pdf_parser_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/pdf_parser_service:latest
	    restart: unless-stopped

	  recurring_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/recurring_service:latest
	    environment:
	      - DATABASE_URL=postgresql://${DB_USER:-appuser}:${DB_PASSWORD:-password}@${DB_HOST:-localhost}:${DB_PORT:-5432}/${DB_NAME:-appdb}
	    restart: unless-stopped

	  user_service:
	    image: ${REGISTRY:-docker.io}/${IMAGE_PREFIX:-yourusername}/user_service:latest
	    environment:
	      - DATABASE_URL=postgresql://${DB_USER:-appuser}:${DB_PASSWORD:-password}@${DB_HOST:-localhost}:${DB_PORT:-5432}/${DB_NAME:-appdb}
	    restart: unless-stopped

	  redis:
	    image: redis:7-alpine
	    restart: unless-stopped
	    volumes:
	      - redis_data:/data

	volumes:
	  redis_data:
	COMPOSEEOF

	echo ""
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	echo "ğŸ“¥ Pulling latest images..."
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	if docker compose pull ${SERVICES}; then
	  echo "âœ… Images pulled successfully"
	else
	  echo "âš ï¸ Some images failed to pull"
	fi
	
	echo ""
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	echo "ğŸ”„ Recreating services: ${SERVICES}"
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	if docker compose up -d ${SERVICES}; then
	  echo "âœ… Services started successfully"
	else
	  echo "âŒ Failed to start some services"
	  exit 1
	fi
	
	echo ""
	echo "ğŸ§¹ Cleaning up old images..."
	docker image prune -f || true
	
	echo ""
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	echo "ğŸ“Š Deployment Status"
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	docker compose ps
	
	echo ""
	echo "âœ… Deployment completed successfully!"
	EOS